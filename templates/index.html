<!DOCTYPE HTML>
<html>
<head>
  <title>Flask-SocketIO Test</title>
  <link rel="stylesheet" href="https://bootswatch.com/cosmo/bootstrap.min.css">
  <style>
    .grid-cell {
      width: 20px;
      height: 20px;
      padding: 0;
    }
    .tunnel {
      background-color: #2d3148;
    }
    .ground {
      background-color: #020206;
    }
  </style>

  <script src="/assets/jquery.js"></script>
  <script src="/assets/socket.js"></script>
  <script src="/assets/vue.js"></script>

  <script>
    $().ready(() => {
      // INIT VUE
      var app = new Vue({
        el: '#el',
        data: {
          messages: [],
          grid: [
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "###.#####################",
            "###.#####################",
            "###.#####################",
            "###.#####################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################"
          ]
        },
        methods: {
          getClass (i, k) {
            return {
              tunnel: this.grid[i][k] == '.',
              ground: this.grid[i][k] != '.'
            }
          }
        },
        created () {
          var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

          socket.emit('new-connection')
          socket.on('readings', (data) => {
            console.log(data)
            this.messages.push(data)
          });

          var ping_pong_times = [];
          var start_time;
          window.setInterval(function() {
            start_time = (new Date).getTime();
            socket.emit('my_ping');
          }, 1000);
          socket.on('my_pong', function() {
            var latency = (new Date).getTime() - start_time;
            ping_pong_times.push(latency);
            console.log(latency)
            ping_pong_times = ping_pong_times.slice(-30); // keep last 30 samples
            var sum = 0;
            for (var i = 0; i < ping_pong_times.length; i++)
                sum += ping_pong_times[i];
            $('#ping-pong').text(Math.round(10 * sum / ping_pong_times.length) / 10);
          });
        }
      })
    });
  </script>
</head>
<body>
  {% raw %}
    <div class="container" id="el" style="padding-top: 40px">

      <div class="row">
        <div class="row" v-for="(row, i) in grid">
          <div v-for="(cell, j) in row">
            <div class="grid-cell" style="float: left" :class="getClass(i, j)"></div>
          </div>
        </div>
      </div>

      <div class="row">
        <ul>
          <li v-for="(message, messageId) in messages">
            {{ message }}
          </li >
        </ul>
      </div>
    </div>
  {% endraw %}
</body>
</html>