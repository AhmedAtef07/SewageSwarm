<!DOCTYPE HTML>
<html>
<head>
  <title>Flask-SocketIO Test</title>
  <link rel="stylesheet" href="https://bootswatch.com/cosmo/bootstrap.min.css">
  <style>
    .grid-cell {
      width: 20px;
      height: 20px;
      text-align: center;
      padding: 0;
    }
    .tunnel {
      background-color: #2d3148;
    }
    .ground {
      background-color: #020206;
    }
  </style>

  <script src="/assets/jquery.js"></script>
  <script src="/assets/socket.js"></script>
  <script src="/assets/vue.js"></script>

  <script>
    dx= [0, 0, 1, -1]
    dy= [1, -1, 0 ,0]
    max_diff= 5    // the maximum difference between 2 neighbouring cells
    init_value= 20   // initial value for array generation

    function dfs(generated, grid, visited, x, y, isIncreasing, prev_temperature, ind){
      console.log(x + " " + y + " " + " " + isIncreasing + " " + generated[x][y])
      visited[x][y]= true
      for(var i= 0; i< 4; i++){
        var u= x+dx[i];
        var v= y+dy[i];
        if(u<grid.length && u>=0 && v<grid[0].length && v>=0 && grid[u][v]!='#' && !visited[u][v]){
          if(isIncreasing){ // monotonically increasing
            generated[u][v]= Math.random()*2*max_diff + generated[x][y] - max_diff;
            var nextIsIncreasing= generated[u][v] > generated[x][y];

            if(nextIsIncreasing) {  // Continue to push and increment the index
              prev_temperature.push(generated[u][v]);
              ind++;
            } else { // Starting from this point you must take the last value from the prev_temp and decrement so the next cell does the same
              generated[u][v]= prev_temperature[ind];
              ind--;
            }

            if(generated[u][v] === undefined){ // Unknown reason, Math.random returns undefined value
              generated[u][v]= Math.random()*2*max_diff + generated[x][y] - max_diff;
              console.log("checkleets")
            }
            dfs(generated, grid, visited, u, v, nextIsIncreasing, prev_temperature, ind);

            if(nextIsIncreasing) {  // Reverse the action of the previous if
              prev_temperature.pop();
              ind--;
            }

          } else { // monotonically decreasing
            generated[u][v]= Math.random()*max_diff + generated[x][y] - max_diff
            if(ind >= 0){
              generated[u][v]= prev_temperature[ind];
            }
            dfs(generated, grid, visited, u, v, false, prev_temperature, ind-1);
          }
        }
      }
    }


    $().ready(() => {
      // INIT VUE
      var app = new Vue({
        el: '#el',
        data: {
          messages: [],
          grid: [
            "#########################",
            "############...##########",
            "#############.###########",
            "#######..........########",
            "#######.########.########",
            "#######.########.########",
            "##.####.########.########",
            "##......########.########",
            "##.#############.##.#####",
            "################....#####",
            "################.##.#####",
            "################.########",
            "#########........########",
            "#########.######.########",
            "#########.#####...#######",
            "#########.###############",
            "#########.###############",
            "########...##############",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################",
            "#########################"
            // "###.#",
            // "#...#",
            // "###.#",
            // "###.#",
            // "#...#",
          ],
          generated: [],
        },
        methods: {
          getClass (i, k) {
            return {
              tunnel: this.grid[i][k] == '.',
              ground: this.grid[i][k] != '.'
            }
          },
          generateRandValues (x, y) {
            // x,y: initial cell node

            // initializing visited array
            var vis = [];
            for(var i= 0; i< this.grid.length; i++){
              var tmp= [];
              for(var j= 0; j< this.grid[0].length; j++){
                tmp.push(false);
              }
              vis.push(tmp);
            }


            // initializing generated number array
            for(var i= 0; i< this.grid.length; i++){
              var tmp= [];
              for(var j= 0; j< this.grid[0].length; j++){
                tmp.push(-1);
              }
              this.generated.push(tmp);
            }
            this.generated[x][y]= init_value
            dfs(this.generated, this.grid, vis, x, y, true, [0], 0)
          },
          getRandomStart () {
            var tunnels= []
            for(var i= 0; i< this.grid.length; i++){
              for(var j= 0; j< this.grid[0].length; j++){
                if(this.grid[i][j] == '.'){
                  tunnels.push({x: i, y: j});
                }
              }
            }
            return tunnels[Math.floor(Math.random()*tunnels.length)];
          },
          randomizeValue () {
            // To generate the random number 2d array, the parameters should be a tunnel cell
            rand_pt = this.getRandomStart()
            // rand_pt= {x:0, y:3};
            this.generateRandValues(rand_pt.x, rand_pt.y);
          }
        },
        created () {
          this.randomizeValue()

          for(var i= 0; i< this.grid.length; i++){
            console.log(this.grid[i])
          }

          for(var i= 0; i< this.grid.length; i++){
            console.log(this.generated[i])
          }

          var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

          socket.emit('new-connection')
          socket.on('readings', (data) => {
            console.log(data)
            this.messages.push(data)
          });

          var ping_pong_times = [];
          var start_time;
          window.setInterval(function() {
            start_time = (new Date).getTime();
            socket.emit('my_ping');
          }, 1000);
          socket.on('my_pong', function() {
            var latency = (new Date).getTime() - start_time;
            ping_pong_times.push(latency);
            console.log(latency)
            ping_pong_times = ping_pong_times.slice(-30); // keep last 30 samples
            var sum = 0;
            for (var i = 0; i < ping_pong_times.length; i++)
                sum += ping_pong_times[i];
            $('#ping-pong').text(Math.round(10 * sum / ping_pong_times.length) / 10);
          });
        }
      })
    });
  </script>
</head>
<body>
  {% raw %}
    <div class="container" id="el" style="padding-top: 40px">

      <div class="row">
        <div class="row" v-for="(row, i) in grid">
          <div v-for="(cell, j) in row">
            <div class="grid-cell" style="float: left; color: red" :class="getClass(i, j)">
              <div v-if="grid[i][j] == '.'" class="reading">
                {{ Math.round(generated[i][j]) }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row options">
        <button class="btn btn-primary" @click="randomizeValue()">Generate</button>
      </div>

      <div class="row">
        <ul>
          <li v-for="(message, messageId) in messages">
            {{ message }}
          </li >
        </ul>
      </div>
    </div>
  {% endraw %}
</body>
</html>